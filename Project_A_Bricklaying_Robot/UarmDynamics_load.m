% MECH 598 Deng Yang
function [tau] = UarmDynamics_load(Theta,Thetad,Thetadd,uarm)
    % Initialize
    l1 = uarm.parameters.l1/1000;
    l2 = uarm.parameters.l2/1000;
    l3 = uarm.parameters.l3/1000;
    l4 = uarm.parameters.l4/1000;
    m1 = uarm.parameters.m1;
    m2 = uarm.parameters.m2;
    m3 = uarm.parameters.m3;
    m4 = uarm.parameters.m4;
    g = uarm.parameters.g;
    G = uarm.parameters.G;
    
    q1 = Theta(1);
    q2 = Theta(2);
    q3 = Theta(3);
    q4 = Theta(4);
    dq1 = Thetad(1);
    dq2 = Thetad(2);
    dq3 = Thetad(3);
    dq4 = Thetad(4);
    ddq1 = Thetadd(1);
    ddq2 = Thetadd(2);
    ddq3 = Thetadd(3);
    ddq4 = Thetadd(4);
    s1 = sin(q1);
    c1 = cos(q1);
    s2 = sin(q2);
    c2 = cos(q2);
    s3 = sin(q3);
    c3 = cos(q3);
    s4 = sin(q4);
    c4 = cos(q4);
    
    tau4 = -l4*m4*(s4*(c3*(l2*(dq1 + dq2)^2 - c2*g + dq1^2*l2*s2^2) - ddq3*l3 + s3*(c2*l2*s2*dq1^2 + g*s2 - l2*(ddq1 + ddq2)) - l3*(c2*dq1*s3 + c3*dq1*s2)*(c2*c3*dq1 - dq1*s2*s3)) + c4*(s3*(l2*(dq1 + dq2)^2 - c2*g + dq1^2*l2*s2^2) + dq3^2*l3 - c3*(c2*l2*s2*dq1^2 + g*s2 - l2*(ddq1 + ddq2)) + l3*(c2*c3*dq1 - dq1*s2*s3)^2) - l4*(ddq3 + ddq4) + l4*(c4*(c2*dq1*s3 + c3*dq1*s2) + s4*(c2*c3*dq1 - dq1*s2*s3))*(c4*(c2*c3*dq1 - dq1*s2*s3) - s4*(c2*dq1*s3 + c3*dq1*s2)));
 
    tau3 = l3*(c4*(G + m4*(s4*(s3*(l2*(dq1 + dq2)^2 - c2*g + dq1^2*l2*s2^2) + dq3^2*l3 - c3*(c2*l2*s2*dq1^2 + g*s2 - l2*(ddq1 + ddq2)) + l3*(c2*c3*dq1 - dq1*s2*s3)^2) - c4*(c3*(l2*(dq1 + dq2)^2 - c2*g + dq1^2*l2*s2^2) - ddq3*l3 + s3*(c2*l2*s2*dq1^2 + g*s2 - l2*(ddq1 + ddq2)) - l3*(c2*dq1*s3 + c3*dq1*s2)*(c2*c3*dq1 - dq1*s2*s3)) + l4*(c4*(c2*dq1*s3 + c3*dq1*s2) + s4*(c2*c3*dq1 - dq1*s2*s3))^2 + l4*(dq3 + dq4)^2)) - m4*s4*(s4*(c3*(l2*(dq1 + dq2)^2 - c2*g + dq1^2*l2*s2^2) - ddq3*l3 + s3*(c2*l2*s2*dq1^2 + g*s2 - l2*(ddq1 + ddq2)) - l3*(c2*dq1*s3 + c3*dq1*s2)*(c2*c3*dq1 - dq1*s2*s3)) + c4*(s3*(l2*(dq1 + dq2)^2 - c2*g + dq1^2*l2*s2^2) + dq3^2*l3 - c3*(c2*l2*s2*dq1^2 + g*s2 - l2*(ddq1 + ddq2)) + l3*(c2*c3*dq1 - dq1*s2*s3)^2) - l4*(ddq3 + ddq4) + l4*(c4*(c2*dq1*s3 + c3*dq1*s2) + s4*(c2*c3*dq1 - dq1*s2*s3))*(c4*(c2*c3*dq1 - dq1*s2*s3) - s4*(c2*dq1*s3 + c3*dq1*s2)))) - l3*m3*(c3*(l2*(dq1 + dq2)^2 - c2*g + dq1^2*l2*s2^2) - ddq3*l3 + s3*(c2*l2*s2*dq1^2 + g*s2 - l2*(ddq1 + ddq2)) - l3*(c2*dq1*s3 + c3*dq1*s2)*(c2*c3*dq1 - dq1*s2*s3)) - l4*m4*(s4*(c3*(l2*(dq1 + dq2)^2 - c2*g + dq1^2*l2*s2^2) - ddq3*l3 + s3*(c2*l2*s2*dq1^2 + g*s2 - l2*(ddq1 + ddq2)) - l3*(c2*dq1*s3 + c3*dq1*s2)*(c2*c3*dq1 - dq1*s2*s3)) + c4*(s3*(l2*(dq1 + dq2)^2 - c2*g + dq1^2*l2*s2^2) + dq3^2*l3 - c3*(c2*l2*s2*dq1^2 + g*s2 - l2*(ddq1 + ddq2)) + l3*(c2*c3*dq1 - dq1*s2*s3)^2) - l4*(ddq3 + ddq4) + l4*(c4*(c2*dq1*s3 + c3*dq1*s2) + s4*(c2*c3*dq1 - dq1*s2*s3))*(c4*(c2*c3*dq1 - dq1*s2*s3) - s4*(c2*dq1*s3 + c3*dq1*s2)));
 
    tau2 = l2*(G*c3*s4 + G*c4*s3 + ddq1*l2*m2 + ddq2*l2*m2 - g*m2*s2 + ddq3*l3*m3*s3 + c3^2*ddq1*l2*m3 + c3^2*ddq2*l2*m3 + c3*dq3^2*l3*m3 - c3^2*g*m3*s2 + ddq1*l2*m3*s3^2 + ddq2*l2*m3*s3^2 - g*m3*s2*s3^2 + c3^2*c4^2*ddq1*l2*m4 + c3^2*c4^2*ddq2*l2*m4 + c3*c4^2*dq3^2*l3*m4 - c3^2*c4^2*g*m4*s2 + c3^2*ddq1*l2*m4*s4^2 + c4^2*ddq1*l2*m4*s3^2 + c3^2*ddq2*l2*m4*s4^2 + c4^2*ddq2*l2*m4*s3^2 + c3*dq3^2*l3*m4*s4^2 - c3^2*g*m4*s2*s4^2 - c4^2*g*m4*s2*s3^2 + ddq1*l2*m4*s3^2*s4^2 + ddq2*l2*m4*s3^2*s4^2 - g*m4*s2*s3^2*s4^2 - c3*c4*ddq3*l4*m4 - c3*c4*ddq4*l4*m4 + c2^2*c3^3*dq1^2*l3*m3 + ddq3*l4*m4*s3*s4 + ddq4*l4*m4*s3*s4 + c4^2*ddq3*l3*m4*s3 - c2*dq1^2*l2*m2*s2 + c3*dq3^2*l4*m4*s4 + c4*dq3^2*l4*m4*s3 + c3*dq4^2*l4*m4*s4 + c4*dq4^2*l4*m4*s3 + ddq3*l3*m4*s3*s4^2 + c2^2*c3^3*c4^2*dq1^2*l3*m4 + c2^2*c3^3*dq1^2*l3*m4*s4^2 + c2^2*c3^3*dq1^2*l4*m4*s4^3 + c2^2*c4^3*dq1^2*l4*m4*s3^3 - c2*c3^2*dq1^2*l2*m3*s2 - c2*dq1^2*l2*m3*s2*s3^2 - c2*dq1^2*l3*m3*s2*s3^3 + 2*c3*dq3*dq4*l4*m4*s4 + 2*c4*dq3*dq4*l4*m4*s3 + c2^2*c3*dq1^2*l3*m3*s3^2 - c2*c3^2*dq1^2*l3*m3*s2*s3 - c2*c3^2*c4^2*dq1^2*l2*m4*s2 + c2*c3^3*c4^3*dq1^2*l4*m4*s2 - c2*c3^2*dq1^2*l2*m4*s2*s4^2 - c2*c4^2*dq1^2*l2*m4*s2*s3^2 - c2*c4^2*dq1^2*l3*m4*s2*s3^3 - c2*dq1^2*l2*m4*s2*s3^2*s4^2 - c2*dq1^2*l3*m4*s2*s3^3*s4^2 - c2*dq1^2*l4*m4*s2*s3^3*s4^3 + c2^2*c3*c4^2*dq1^2*l3*m4*s3^2 + c2^2*c3^2*c4^3*dq1^2*l4*m4*s3 + c2^2*c3^3*c4^2*dq1^2*l4*m4*s4 + c2^2*c3*dq1^2*l3*m4*s3^2*s4^2 + c2^2*c3*dq1^2*l4*m4*s3^2*s4^3 + c2^2*c4*dq1^2*l4*m4*s3^3*s4^2 + c2^2*c3*c4^2*dq1^2*l4*m4*s3^2*s4 + c2^2*c3^2*c4*dq1^2*l4*m4*s3*s4^2 - c2*c3^2*c4^2*dq1^2*l3*m4*s2*s3 + c2*c3*c4^3*dq1^2*l4*m4*s2*s3^2 + c2*c3^3*c4*dq1^2*l4*m4*s2*s4^2 - c2*c3^2*dq1^2*l3*m4*s2*s3*s4^2 - c2*c3^2*dq1^2*l4*m4*s2*s3*s4^3 - c2*c4^2*dq1^2*l4*m4*s2*s3^3*s4 + c2*c3*c4*dq1^2*l4*m4*s2*s3^2*s4^2 - c2*c3^2*c4^2*dq1^2*l4*m4*s2*s3*s4);
 
    tau1 = ddq1*l2^2*m2 + ddq2*l2^2*m2 + c3^2*ddq1*l2^2*m3 + c3^2*ddq2*l2^2*m3 + ddq1*l2^2*m2*s2^2 + ddq1*l2^2*m3*s3^2 + ddq2*l2^2*m3*s3^2 + G*c3*l2*s4 + G*c4*l2*s3 + ddq3*l2*l3*m3*s3 + c2^2*c3^2*ddq1*l3^2*m3 + c2^2*c3^2*ddq1*l3^2*m4 + c3^2*c4^2*ddq1*l2^2*m4 + c3^2*c4^2*ddq2*l2^2*m4 + c3^2*ddq1*l2^2*m4*s4^2 + c4^2*ddq1*l2^2*m4*s3^2 + c3^2*ddq2*l2^2*m4*s4^2 + c4^2*ddq2*l2^2*m4*s3^2 + ddq1*l3^2*m3*s2^2*s3^2 + ddq1*l3^2*m4*s2^2*s3^2 + ddq1*l2^2*m4*s3^2*s4^2 + ddq2*l2^2*m4*s3^2*s4^2 + c3*dq3^2*l2*l3*m3 - c3^2*g*l2*m3*s2 - g*l2*m3*s2*s3^2 - c2*dq1^2*l2^2*m3*s2*s3^2 + 2*c2*dq1*dq2*l2^2*m2*s2 + c4^2*ddq3*l2*l3*m4*s3 + c3*dq3^2*l2*l4*m4*s4 + c4*dq3^2*l2*l4*m4*s3 + c3*dq4^2*l2*l4*m4*s4 + c4*dq4^2*l2*l4*m4*s3 + ddq3*l2*l3*m4*s3*s4^2 + c2^2*c3^2*ddq1*l4^2*m4*s4^2 + c2^2*c4^2*ddq1*l4^2*m4*s3^2 + c3^2*c4^2*ddq1*l4^2*m4*s2^2 + ddq1*l4^2*m4*s2^2*s3^2*s4^2 + c3*c4^2*dq3^2*l2*l3*m4 - c3^2*c4^2*g*l2*m4*s2 + c3*dq3^2*l2*l3*m4*s4^2 - c3^2*g*l2*m4*s2*s4^2 - c4^2*g*l2*m4*s2*s3^2 - g*l2*m4*s2*s3^2*s4^2 - c3*c4*ddq3*l2*l4*m4 - c3*c4*ddq4*l2*l4*m4 + c2^2*c3^3*dq1^2*l2*l3*m3 + ddq3*l2*l4*m4*s3*s4 + ddq4*l2*l4*m4*s3*s4 - c2*c3^2*dq1^2*l2^2*m3*s2 + 2*c2^2*c3^2*ddq1*l3*l4*m4*s4 + c2*dq1*dq2*l3^2*m3*s2*s3^2 + c2*dq1*dq2*l3^2*m4*s2*s3^2 + 2*c2*dq1*dq3*l3^2*m3*s2*s3^2 + c3*dq1*dq2*l3^2*m3*s2^2*s3 + 2*c2*dq1*dq3*l3^2*m4*s2*s3^2 + c3*dq1*dq2*l3^2*m4*s2^2*s3 + 2*c3*dq1*dq3*l3^2*m3*s2^2*s3 + 2*c3*dq1*dq3*l3^2*m4*s2^2*s3 - c2*dq1^2*l2*l3*m3*s2*s3^3 + 2*ddq1*l3*l4*m4*s2^2*s3^2*s4 + 2*c3*dq3*dq4*l2*l4*m4*s4 + 2*c4*dq3*dq4*l2*l4*m4*s3 + c2^2*c3*dq1^2*l2*l3*m3*s3^2 - 2*c2*c3*ddq1*l3^2*m3*s2*s3 - 2*c2*c3*ddq1*l3^2*m4*s2*s3 + c2^2*c3^3*c4^2*dq1^2*l2*l3*m4 - c2*c3^2*c4^2*dq1^2*l2^2*m4*s2 + c2^2*c3^3*dq1^2*l2*l3*m4*s4^2 + c2^2*c3^3*dq1^2*l2*l4*m4*s4^3 + c2^2*c4^3*dq1^2*l2*l4*m4*s3^3 - c2*c3^2*dq1^2*l2^2*m4*s2*s4^2 - c2*c4^2*dq1^2*l2^2*m4*s2*s3^2 - c2*dq1^2*l2^2*m4*s2*s3^2*s4^2 - c2*c3^2*dq1*dq2*l3^2*m3*s2 - c2*c3^2*dq1*dq2*l3^2*m4*s2 - 2*c2*c3^2*dq1*dq3*l3^2*m3*s2 - c2^2*c3*dq1*dq2*l3^2*m3*s3 - 2*c2*c3^2*dq1*dq3*l3^2*m4*s2 - c2^2*c3*dq1*dq2*l3^2*m4*s3 - 2*c2^2*c3*dq1*dq3*l3^2*m3*s3 - 2*c2^2*c3*dq1*dq3*l3^2*m4*s3 + 2*c2*c3^2*c4*ddq1*l3*l4*m4*s2 + 2*c2^2*c3*c4*ddq1*l3*l4*m4*s3 - 2*c2*c4*ddq1*l3*l4*m4*s2*s3^2 - 2*c3*c4*ddq1*l3*l4*m4*s2^2*s3 + c2^2*c3*c4^2*dq1^2*l2*l3*m4*s3^2 + c2^2*c3^2*c4^3*dq1^2*l2*l4*m4*s3 + c2^2*c3^3*c4^2*dq1^2*l2*l4*m4*s4 + c2^2*c3*dq1^2*l2*l3*m4*s3^2*s4^2 + c2^2*c3*dq1^2*l2*l4*m4*s3^2*s4^3 + c2^2*c4*dq1^2*l2*l4*m4*s3^3*s4^2 + c2^2*c3^2*c4*dq1*dq2*l3*l4*m4 + 2*c2^2*c3^2*c4*dq1*dq3*l3*l4*m4 + 2*c2^2*c3^2*c4*dq1*dq4*l3*l4*m4 - c2^2*c4*dq1*dq2*l3*l4*m4*s3^2 - c3^2*c4*dq1*dq2*l3*l4*m4*s2^2 - 2*c2^2*c4*dq1*dq3*l3*l4*m4*s3^2 - 2*c3^2*c4*dq1*dq3*l3*l4*m4*s2^2 + 2*c2*c3*c4^2*ddq1*l4^2*m4*s2*s3 + 2*c2*c3^2*c4*ddq1*l4^2*m4*s2*s4 + 2*c2^2*c3*c4*ddq1*l4^2*m4*s3*s4 - c2*c3^2*dq1^2*l2*l3*m3*s2*s3 + c4*dq1*dq2*l3*l4*m4*s2^2*s3^2 + 2*c4*dq1*dq3*l3*l4*m4*s2^2*s3^2 + 2*c4*dq1*dq4*l3*l4*m4*s2^2*s3^2 - 2*c2*c3*ddq1*l4^2*m4*s2*s3*s4^2 - 2*c2*c4*ddq1*l4^2*m4*s2*s3^2*s4 - 2*c3*c4*ddq1*l4^2*m4*s2^2*s3*s4 + c2*c3^2*c4^2*dq1*dq2*l4^2*m4*s2 + 2*c2*c3^2*c4^2*dq1*dq3*l4^2*m4*s2 + c2^2*c3*c4^2*dq1*dq2*l4^2*m4*s3 + 2*c2*c3^2*c4^2*dq1*dq4*l4^2*m4*s2 + 2*c2^2*c3*c4^2*dq1*dq3*l4^2*m4*s3 + c2^2*c3^2*c4*dq1*dq2*l4^2*m4*s4 + 2*c2^2*c3*c4^2*dq1*dq4*l4^2*m4*s3 + 2*c2^2*c3^2*c4*dq1*dq3*l4^2*m4*s4 + 2*c2^2*c3^2*c4*dq1*dq4*l4^2*m4*s4 + c2*c3^3*c4^3*dq1^2*l2*l4*m4*s2 - c2*c3^2*dq1*dq2*l4^2*m4*s2*s4^2 - c2*c4^2*dq1*dq2*l4^2*m4*s2*s3^2 - 2*c2*c3^2*dq1*dq3*l4^2*m4*s2*s4^2 - 2*c2*c4^2*dq1*dq3*l4^2*m4*s2*s3^2 - c3*c4^2*dq1*dq2*l4^2*m4*s2^2*s3 - c2^2*c3*dq1*dq2*l4^2*m4*s3*s4^2 - 2*c2*c3^2*dq1*dq4*l4^2*m4*s2*s4^2 - 2*c2*c4^2*dq1*dq4*l4^2*m4*s2*s3^2 - 2*c3*c4^2*dq1*dq3*l4^2*m4*s2^2*s3 - 2*c2^2*c3*dq1*dq3*l4^2*m4*s3*s4^2 - c2^2*c4*dq1*dq2*l4^2*m4*s3^2*s4 - c3^2*c4*dq1*dq2*l4^2*m4*s2^2*s4 - 2*c3*c4^2*dq1*dq4*l4^2*m4*s2^2*s3 - 2*c2^2*c3*dq1*dq4*l4^2*m4*s3*s4^2 - 2*c2^2*c4*dq1*dq3*l4^2*m4*s3^2*s4 - 2*c3^2*c4*dq1*dq3*l4^2*m4*s2^2*s4 - 2*c2^2*c4*dq1*dq4*l4^2*m4*s3^2*s4 - 2*c3^2*c4*dq1*dq4*l4^2*m4*s2^2*s4 - c2*c4^2*dq1^2*l2*l3*m4*s2*s3^3 + c2*dq1*dq2*l4^2*m4*s2*s3^2*s4^2 + 2*c2*dq1*dq3*l4^2*m4*s2*s3^2*s4^2 + c3*dq1*dq2*l4^2*m4*s2^2*s3*s4^2 + 2*c2*dq1*dq4*l4^2*m4*s2*s3^2*s4^2 + 2*c3*dq1*dq3*l4^2*m4*s2^2*s3*s4^2 + c4*dq1*dq2*l4^2*m4*s2^2*s3^2*s4 + 2*c3*dq1*dq4*l4^2*m4*s2^2*s3*s4^2 + 2*c4*dq1*dq3*l4^2*m4*s2^2*s3^2*s4 + 2*c4*dq1*dq4*l4^2*m4*s2^2*s3^2*s4 - c2*dq1^2*l2*l3*m4*s2*s3^3*s4^2 - c2*dq1^2*l2*l4*m4*s2*s3^3*s4^3 - 4*c2*c3*ddq1*l3*l4*m4*s2*s3*s4 - c2*c3^2*c4^2*dq1^2*l2*l3*m4*s2*s3 + c2*c3*c4^3*dq1^2*l2*l4*m4*s2*s3^2 + c2*c3^3*c4*dq1^2*l2*l4*m4*s2*s4^2 - c2*c3^2*dq1^2*l2*l3*m4*s2*s3*s4^2 - c2*c3^2*dq1^2*l2*l4*m4*s2*s3*s4^3 - c2*c4^2*dq1^2*l2*l4*m4*s2*s3^3*s4 - 2*c2*c3^2*dq1*dq2*l3*l4*m4*s2*s4 - 4*c2*c3^2*dq1*dq3*l3*l4*m4*s2*s4 - 2*c2^2*c3*dq1*dq2*l3*l4*m4*s3*s4 - 2*c2*c3^2*dq1*dq4*l3*l4*m4*s2*s4 - 4*c2^2*c3*dq1*dq3*l3*l4*m4*s3*s4 - 2*c2^2*c3*dq1*dq4*l3*l4*m4*s3*s4 + 2*c2*dq1*dq2*l3*l4*m4*s2*s3^2*s4 + 4*c2*dq1*dq3*l3*l4*m4*s2*s3^2*s4 + 2*c3*dq1*dq2*l3*l4*m4*s2^2*s3*s4 + 2*c2*dq1*dq4*l3*l4*m4*s2*s3^2*s4 + 4*c3*dq1*dq3*l3*l4*m4*s2^2*s3*s4 + 2*c3*dq1*dq4*l3*l4*m4*s2^2*s3*s4 + c2^2*c3*c4^2*dq1^2*l2*l4*m4*s3^2*s4 + c2^2*c3^2*c4*dq1^2*l2*l4*m4*s3*s4^2 - 4*c2*c3*c4*dq1*dq2*l3*l4*m4*s2*s3 - 8*c2*c3*c4*dq1*dq3*l3*l4*m4*s2*s3 - 4*c2*c3*c4*dq1*dq4*l3*l4*m4*s2*s3 + c2*c3*c4*dq1^2*l2*l4*m4*s2*s3^2*s4^2 - c2*c3^2*c4^2*dq1^2*l2*l4*m4*s2*s3*s4 - 4*c2*c3*c4*dq1*dq2*l4^2*m4*s2*s3*s4 - 8*c2*c3*c4*dq1*dq3*l4^2*m4*s2*s3*s4 - 8*c2*c3*c4*dq1*dq4*l4^2*m4*s2*s3*s4;
 
    tau = [tau1;tau2;tau3;tau4];
end